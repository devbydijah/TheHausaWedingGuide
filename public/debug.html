<!DOCTYPE html>
<html>
  <head>
    <title>Debug Payment Flow</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 10px 0;
        background: #b45309;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Payment Flow Debug Tool</h1>

    <div class="section">
      <h3>Step 1: Test API Endpoints</h3>
      <button onclick="testSetup()">Test Setup</button>
      <button onclick="testWithFakeReference()">
        Test with Fake Reference
      </button>
      <pre id="apiResults"></pre>
    </div>

    <div class="section">
      <h3>Step 2: Simulate Success Page</h3>
      <input
        type="text"
        id="referenceInput"
        placeholder="Enter Paystack reference"
        style="width: 300px; padding: 8px"
      />
      <button onclick="simulateSuccess()">Simulate Success Page</button>
      <pre id="successResults"></pre>
    </div>

    <div class="section">
      <h3>Step 3: Environment Check</h3>
      <button onclick="checkEnvironment()">Check Environment Variables</button>
      <pre id="envResults"></pre>
    </div>

    <script>
      async function testSetup() {
        const results = document.getElementById("apiResults");
        results.textContent = "Testing setup...";

        try {
          const response = await fetch("/api/test-setup");
          const data = await response.json();
          results.innerHTML = `<span class="${
            data.status === "success" ? "success" : "error"
          }">
                    Status: ${data.status}
                </span>\n${JSON.stringify(data, null, 2)}`;
        } catch (error) {
          results.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        }
      }

      async function testWithFakeReference() {
        const results = document.getElementById("apiResults");
        results.textContent = "Testing with fake reference...";

        try {
          const response = await fetch("/api/get-download-details", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reference: "fake_reference_12345" }),
          });
          const data = await response.json();
          results.innerHTML = `Response Status: ${
            response.status
          }\n${JSON.stringify(data, null, 2)}`;
        } catch (error) {
          results.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        }
      }

      async function simulateSuccess() {
        const reference = document.getElementById("referenceInput").value;
        const results = document.getElementById("successResults");

        if (!reference) {
          results.innerHTML =
            '<span class="error">Please enter a reference</span>';
          return;
        }

        results.textContent = "Making API call...";

        try {
          const response = await fetch("/api/get-download-details", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reference }),
          });
          const data = await response.json();
          results.innerHTML = `Response Status: ${response.status}
Response Data:
${JSON.stringify(data, null, 2)}`;
        } catch (error) {
          results.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        }
      }

      async function checkEnvironment() {
        const results = document.getElementById("envResults");
        results.textContent = "Checking environment...";

        // This won't show actual values for security, but will show if APIs respond
        const checks = [
          { name: "Test Setup API", url: "/api/test-setup" },
          {
            name: "Get Download Details API",
            url: "/api/get-download-details",
            method: "POST",
            body: { reference: "test" },
          },
        ];

        let output = "";
        for (const check of checks) {
          try {
            const options = {
              method: check.method || "GET",
              headers: check.body ? { "Content-Type": "application/json" } : {},
              body: check.body ? JSON.stringify(check.body) : undefined,
            };

            const response = await fetch(check.url, options);
            output += `✅ ${check.name}: ${response.status} ${response.statusText}\n`;
          } catch (error) {
            output += `❌ ${check.name}: ${error.message}\n`;
          }
        }

        results.textContent = output;
      }
    </script>
  </body>
</html>
